
<!DOCTYPE html>
<html>
<head>
    <title>LoRA Analysis Interactive Plot</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        
        .controls {
            width: 300px;
            padding: 20px;
            background-color: #f5f5f5;
            overflow-y: auto;
        }
        
        .plot-container {
            flex: 1;
            min-width: 0;
            height: 100%;
            position: relative;
        }
        
        #plot {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .filter-group {
            margin-bottom: 20px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .range-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
            align-items: center;
        }
        
        .range-inputs input[type="number"] {
            width: 80px;
            padding: 5px;
        }
        
        .range-inputs span {
            color: #666;
        }
        
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
        
        input[type="number"] {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
        }
        
        button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        #stats {
            margin-top: 15px;
            font-size: 0.9em;
        }
        .token-select {
            width: 100%;
            padding: 8px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
        }
        
        /* Add a max-height and scrolling for long token lists */
        .token-select select {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h2>Filters</h2>
            
            <div class="filter-group">
                <label>Base Probability</label>
                <div class="range-inputs">
                    <input type="number" id="base_prob_min" step="0.01" value="0" min="0" max="1">
                    <span>to</span>
                    <input type="number" id="base_prob_max" step="0.01" value="1" min="0" max="1">
                </div>
                <input type="range" id="base_prob_range" min="0" max="100" value="0,100">
            </div>
            
            <div class="filter-group">
                <label>Full-LoRA Difference</label>
                <div class="range-inputs">
                    <input type="number" id="full_lora_diff_min" step="0.01" value="-1" min="-1" max="1">
                    <span>to</span>
                    <input type="number" id="full_lora_diff_max" step="0.01" value="1" min="-1" max="1">
                </div>
                <input type="range" id="full_lora_diff_range" min="0" max="100" value="0,100">
            </div>
            
            <div class="filter-group">
                <label>Relative Prevalence</label>
                <div class="range-inputs">
                    <input type="number" id="rel_prev_min" step="0.01" value="-1" min="-1" max="1">
                    <span>to</span>
                    <input type="number" id="rel_prev_max" step="0.01" value="1" min="-1" max="1">
                </div>
                <input type="range" id="rel_prev_range" min="0" max="100" value="0,100">
            </div>
            
            <button onclick="updatePlot()">Update Plot</button>
            <div id="stats"></div>
        </div>
        <div class="plot-container">
            <div id="plot"></div>
        </div>
    </div>

    <script>
        let plotData;
        let plotLayout;
        let uniqueTokens = new Set();

        // Load the initial data and plot
        fetch('plot_data.json')
            .then(response => response.json())
            .then(data => {
                plotData = data;
                
                // Populate token dropdown
                uniqueTokens = new Set(data.map(d => d.curr_token));
                const tokenSelect = document.getElementById('token_select');
                uniqueTokens.forEach(token => {
                    const option = document.createElement('option');
                    option.value = token;
                    option.text = token;
                    tokenSelect.appendChild(option);
                });
                
                createPlot(data);
            });

            function createPlot(data) {
            const trace = {
                type: 'scatter3d',
                mode: 'markers',
                x: data.map(d => d.full_prob),
                y: data.map(d => d.lora_prob),
                z: data.map(d => d.base_prob),
                marker: {
                    size: 2,
                    color: data.map(d => d.rel_prev),
                    colorscale: 'Viridis',
                    colorbar: {
                        title: 'Relative Prevalence',
                        thickness: 20,
                        len: 0.75
                    },
                    showscale: true  // This ensures the colorbar is displayed
                },
                customdata: data.map(d => [
                    d.wrapped_context,
                    d.curr_token,
                    d.base_prob,
                    d.full_prob,
                    d.lora_prob,
                    d.rel_prev
                ]),
                hovertemplate: 
                    "Context: %{customdata[0]}<br>" +
                    "Token: %{customdata[1]}<br>" +
                    "Base Prob: %{customdata[2]:.4f}<br>" +
                    "Full-FT Prob: %{customdata[3]:.4f}<br>" +
                    "LoRA-FT Prob: %{customdata[4]:.4f}<br>" +
                    "Rel Prev: %{customdata[5]:.4f}<br>" +
                    "<extra></extra>"
            };

            plotLayout = {
                scene: {
                    xaxis: {
                        title: 'Full-FT Prob',
                        range: [0, 1],
                        autorange: false
                    },
                    yaxis: {
                        title: 'LoRA-FT Prob',
                        range: [0, 1],
                        autorange: false
                    },
                    zaxis: {
                        title: 'Base Prob',
                        range: [0, 1],
                        autorange: false
                    },
                    aspectmode: 'cube'
                },
                margin: {l: 0, r: 0, t: 0, b: 0},
                autosize: true
            };

            Plotly.newPlot('plot', [trace], plotLayout, {
                responsive: true,
                displayModeBar: true
            });
        }

        // Function to map slider value (0-100) to actual range
        function mapSliderToRange(value, min, max) {
            return min + (value / 100) * (max - min);
        }

        // Function to setup range slider
        function setupRangeSlider(name, minVal, maxVal) {
            const slider = document.getElementById(`${name}_range`);
            const minInput = document.getElementById(`${name}_min`);
            const maxInput = document.getElementById(`${name}_max`);

            noUiSlider.create(slider, {
                start: [0, 100],
                connect: true,
                range: {
                    'min': 0,
                    'max': 100
                }
            });

            slider.noUiSlider.on('update', function (values, handle) {
                const mappedValue = mapSliderToRange(values[handle], minVal, maxVal);
                if (handle === 0) {
                    minInput.value = mappedValue.toFixed(2);
                } else {
                    maxInput.value = mappedValue.toFixed(2);
                }
            });

            // Update slider when inputs change
            minInput.addEventListener('change', function() {
                const value = (this.value - minVal) / (maxVal - minVal) * 100;
                slider.noUiSlider.setHandle(0, value);
            });

            maxInput.addEventListener('change', function() {
                const value = (this.value - minVal) / (maxVal - minVal) * 100;
                slider.noUiSlider.setHandle(1, value);
            });
        }

        // Setup all range sliders
        setupRangeSlider('base_prob', 0, 1);
        setupRangeSlider('full_lora_diff', -1, 1);
        setupRangeSlider('rel_prev', -1, 1);

        function updatePlot() {
            const selectedTokens = Array.from(document.getElementById('token_select').selectedOptions).map(option => option.value);
            
            const filteredData = plotData.filter(d => {
                const tokenMatch = selectedTokens.length === 0 || selectedTokens.includes(d.curr_token);
                return tokenMatch &&
                       d.base_prob >= parseFloat(document.getElementById('base_prob_min').value) &&
                       d.base_prob <= parseFloat(document.getElementById('base_prob_max').value) &&
                       d.full_lora_diff >= parseFloat(document.getElementById('full_lora_diff_min').value) &&
                       d.full_lora_diff <= parseFloat(document.getElementById('full_lora_diff_max').value) &&
                       d.rel_prev >= parseFloat(document.getElementById('rel_prev_min').value) &&
                       d.rel_prev <= parseFloat(document.getElementById('rel_prev_max').value);
            });

            document.getElementById('stats').innerHTML = `Showing ${filteredData.length} points`;
            createPlot(filteredData);
        }

        // Add event listener for token selection
        document.getElementById('token_select').addEventListener('change', updatePlot);
        
    </script>
</body>
</html>