
<!DOCTYPE html>
<html>
<head>
    <title>LoRA Analysis Interactive Plot</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        
        .controls {
            width: 300px;
            padding: 20px;
            background-color: #f5f5f5;
            overflow-y: auto;
        }
        
        .plot-container {
            flex: 1;
            min-width: 0;  /* Prevents flex item from overflowing */
            height: 100%;
            position: relative;
        }
        
        #plot {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .filter-group input {
            width: 100%;
        }
        
        button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        #stats {
            margin-top: 15px;
            font-size: 0.9em;
        }
        .filter-group {
            margin-bottom: 20px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .range-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
            align-items: center;
        }
        
        .range-inputs input[type="number"] {
            width: 80px;
            padding: 5px;
        }
        
        .range-inputs span {
            color: #666;
        }
        
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
        
        /* Style for number inputs */
        input[type="number"] {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h2>Filters</h2>
            
            <div class="filter-group">
                <label>Base Probability</label>
                <div class="range-inputs">
                    <input type="number" id="base_prob_min_input" step="0.01" value="0" min="0" max="1">
                    <span>to</span>
                    <input type="number" id="base_prob_max_input" step="0.01" value="1" min="0" max="1">
                </div>
                <input type="range" id="base_prob_min_slider" min="0" max="1" step="0.01" value="0">
                <input type="range" id="base_prob_max_slider" min="0" max="1" step="0.01" value="1">
            </div>
            
            <div class="filter-group">
                <label>Full-LoRA Difference</label>
                <div class="range-inputs">
                    <input type="number" id="full_lora_diff_min_input" step="0.01" value="-1" min="-1" max="1">
                    <span>to</span>
                    <input type="number" id="full_lora_diff_max_input" step="0.01" value="1" min="-1" max="1">
                </div>
                <input type="range" id="full_lora_diff_min_slider" min="-1" max="1" step="0.01" value="-1">
                <input type="range" id="full_lora_diff_max_slider" min="-1" max="1" step="0.01" value="1">
            </div>
            
            <div class="filter-group">
                <label>Relative Prevalence</label>
                <div class="range-inputs">
                    <input type="number" id="rel_prev_min_input" step="0.01" value="-1" min="-1" max="1">
                    <span>to</span>
                    <input type="number" id="rel_prev_max_input" step="0.01" value="1" min="-1" max="1">
                </div>
                <input type="range" id="rel_prev_min_slider" min="-1" max="1" step="0.01" value="-1">
                <input type="range" id="rel_prev_max_slider" min="-1" max="1" step="0.01" value="1">
            </div>
            
            <button onclick="updatePlot()">Update Plot</button>
            <div id="stats"></div>
        </div>
        <div class="plot-container">
            <div id="plot"></div>
        </div>
    </div>

    <script>
        let plotData;
        let plotLayout;

        // Load the initial data and plot
        fetch('plot_data.json')
            .then(response => response.json())
            .then(data => {
                plotData = data;
                createPlot(data);
            });

        function createPlot(data) {
            const trace = {
                type: 'scatter3d',
                mode: 'markers',
                x: data.map(d => d.full_prob),
                y: data.map(d => d.lora_prob),
                z: data.map(d => d.base_prob),
                marker: {
                    size: 1.5,
                    color: data.map(d => d.rel_prev),
                    colorscale: 'Viridis'
                },
                customdata: data.map(d => [
                    d.wrapped_context,
                    d.curr_token,
                    d.base_prob,
                    d.full_prob,
                    d.lora_prob,
                    d.rel_prev
                ]),
                hovertemplate: 
                    "Context: %{customdata[0]}<br>" +
                    "Token: %{customdata[1]}<br>" +
                    "Base Prob: %{customdata[2]:.4f}<br>" +
                    "Full-FT Prob: %{customdata[3]:.4f}<br>" +
                    "LoRA-FT Prob: %{customdata[4]:.4f}<br>" +
                    "Rel Prev: %{customdata[5]:.4f}<br>" +
                    "<extra></extra>"
            };

            plotLayout = {
                scene: {
                    xaxis: {
                        title: 'Full-FT Prob',
                        range: [0, 1],  // Fixed range
                        autorange: false
                    },
                    yaxis: {
                        title: 'LoRA-FT Prob',
                        range: [0, 1],  // Fixed range
                        autorange: false
                    },
                    zaxis: {
                        title: 'Base Prob',
                        range: [0, 1],  // Fixed range
                        autorange: false
                    },
                    aspectmode: 'cube'  // Makes the plot cubic for better visualization
                },
                margin: {l: 0, r: 0, t: 0, b: 0},
                autosize: true
            };

            Plotly.newPlot('plot', [trace], plotLayout, {
                responsive: true,
                displayModeBar: true
        });

        function updatePlot() {
            const filteredData = plotData.filter(d => {
                return d.base_prob >= parseFloat(document.getElementById('base_prob_min').value) &&
                       d.base_prob <= parseFloat(document.getElementById('base_prob_max').value) &&
                       d.full_lora_diff >= parseFloat(document.getElementById('full_lora_diff_min').value) &&
                       d.full_lora_diff <= parseFloat(document.getElementById('full_lora_diff_max').value) &&
                       d.rel_prev >= parseFloat(document.getElementById('rel_prev_min').value) &&
                       d.rel_prev <= parseFloat(document.getElementById('rel_prev_max').value);
            });

            document.getElementById('stats').innerHTML = `Showing ${filteredData.length} points`;
            createPlot(filteredData);
        }
        // Function to sync slider and input values
        function setupRangeSync(name) {
            const minInput = document.getElementById(`${name}_min_input`);
            const maxInput = document.getElementById(`${name}_max_input`);
            const minSlider = document.getElementById(`${name}_min_slider`);
            const maxSlider = document.getElementById(`${name}_max_slider`);
            
            // Sync min input/slider
            minInput.addEventListener('input', function() {
                minSlider.value = this.value;
                // Ensure max is not less than min
                if (parseFloat(maxInput.value) < parseFloat(this.value)) {
                    maxInput.value = this.value;
                    maxSlider.value = this.value;
                }
            });
            
            minSlider.addEventListener('input', function() {
                minInput.value = this.value;
                // Ensure max is not less than min
                if (parseFloat(maxSlider.value) < parseFloat(this.value)) {
                    maxSlider.value = this.value;
                    maxInput.value = this.value;
                }
            });
            
            // Sync max input/slider
            maxInput.addEventListener('input', function() {
                maxSlider.value = this.value;
                // Ensure min is not greater than max
                if (parseFloat(minInput.value) > parseFloat(this.value)) {
                    minInput.value = this.value;
                    minSlider.value = this.value;
                }
            });
            
            maxSlider.addEventListener('input', function() {
                maxInput.value = this.value;
                // Ensure min is not greater than max
                if (parseFloat(minSlider.value) > parseFloat(this.value)) {
                    minSlider.value = this.value;
                    minInput.value = this.value;
                }
            });
        }

        // Setup sync for all range inputs
        setupRangeSync('base_prob');
        setupRangeSync('full_lora_diff');
        setupRangeSync('rel_prev');

        function updatePlot() {
            const filteredData = plotData.filter(d => {
                return d.base_prob >= parseFloat(document.getElementById('base_prob_min_input').value) &&
                       d.base_prob <= parseFloat(document.getElementById('base_prob_max_input').value) &&
                       d.full_lora_diff >= parseFloat(document.getElementById('full_lora_diff_min_input').value) &&
                       d.full_lora_diff <= parseFloat(document.getElementById('full_lora_diff_max_input').value) &&
                       d.rel_prev >= parseFloat(document.getElementById('rel_prev_min_input').value) &&
                       d.rel_prev <= parseFloat(document.getElementById('rel_prev_max_input').value);
            });

            document.getElementById('stats').innerHTML = `Showing ${filteredData.length} points`;
            createPlot(filteredData);
        }
    </script>
</body>
</html>
